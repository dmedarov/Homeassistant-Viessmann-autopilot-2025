# Loads default set of integrations. Do not remove.
default_config:

# Frontend & themes
frontend:
  themes: !include_dir_merge_named themes

# Основни файлове
automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml
python_script:

# Proxmox VE
proxmoxve:
  - host: 192.168.0.33
    username: root@pam
    password: Pretorianec
    realm: pam
    verify_ssl: false
    nodes:
      - node: pve
        vms:
          - 100
          - 101
        # containers:
        #   - 200   # махни или коментирай, ако нямаш LXC 200

# InfluxDB 1.x
influxdb:
  host: 192.168.0.35
  port: 8086
  ssl: false
  verify_ssl: false
  api_version: 1
  username: homeassistant
  password: gekHod-xughe1-zytqiq
  database: homeassistant
  max_retries: 3
  default_measurement: state
  measurement_attr: unit_of_measurement
  tags:
    source: HA
  tags_attributes:
    - friendly_name
    - unit_of_measurement
  ignore_attributes:
    - icon
    - source
    - options
    - editable
    - step
    - mode
    - preset_modes
    - supported_features
    - effect_list
    - attribution
    - device_class
    - state_class
  exclude:
    domains:
      - automation
      - scene
      - script
      - update
      - camera
      - light
      - media_player
      - fan
  include:
    entities:
      - sensor.bedroom_damian_temperature
      - sensor.bedroom_damian_humidity
      - sensor.bedroom_honey_temperature
      - sensor.bedroom_honey_humidity
      - sensor.downstairs_temperature
      - sensor.downstairs_humidity
      - sensor.home_living_room_temperature
      - sensor.home_living_room_humidity
      - sensor.home_living_room_pressure
      - sensor.home_living_room_noise
      - sensor.home_living_room_co2
      - sensor.alex_room_temperature
      - sensor.garage_temperature
      - sensor.garage_humidity
      - sensor.garden_temperature
      - sensor.house_avg_temperature
      - sensor.house_min_temperature
      - sensor.indoor_temperature_avg

      - sensor.cu401b_s_outside_temperature
      - sensor.cu401b_s_compressor_hours
      - sensor.cu401b_s_compressor_starts
      - sensor.cu401b_s_supply_temperature
      - sensor.cu401b_s_return_temperature
      - binary_sensor.cu401b_s_frost_protection
      - binary_sensor.viessmann_compressor_running
      - number.cu401b_s_heating_curve_slope
      - number.cu401b_s_heating_curve_shift
      - number.cu401b_s_normal_temperature
      - number.cu401b_s_reduced_temperature
      - input_number.heating_offset_dynamic

      - input_number.comfort_target_temp
      - input_number.sleep_target_temp
      - input_number.heating_base_slope
      - input_number.heating_cold_slope
      - input_boolean.heating_preheat_48h_force
      - input_boolean.heating_weekend_mode_auto

      - sensor.heating_pi_integral
      - sensor.pi_integral_living
      - sensor.pi_integral_damian
      - sensor.pi_integral_honey
      - sensor.pi_integral_downstairs
      - sensor.pi_integral_alex

      - device_tracker.damian_iphone_14
      - binary_sensor.workday_sensor
      - calendar.blgarski_ofitsialni_praznitsi_2025_2030

      - sensor.forecast_min_72h
      - sensor.openmeteo_daily_min_temperature
      - sensor.power_production_now
      - sensor.estimated_power_production_in_1_hour
      - sensor.energy_production_today_remaining

      - sensor.speedtest_download
      - sensor.speedtest_upload
      - sensor.cyberpower_battery_charge

# ───── TEMPLATE СЕНЗОРИ — ПЕРФЕКТНИ, СТАБИЛНИ И 100 % СЪВМЕСТИМИ С VIESMANN CU401B S 2025 ─────
template:
  - sensor:
      # 1. Външна температура
      - name: "Outdoor Temperature"
        unique_id: outdoor_temperature
        unit_of_measurement: "°C"
        device_class: temperature
        state_class: measurement
        icon: mdi:thermometer
        state: >-
          {% set v = states('sensor.cu401b_s_outside_temperature')|float(default=5) %}
          {{ v|round(1) if v|abs < 80 else states('sensor.netatmo_outdoor_temperature')|float(default=5)|round(1) }}

      # 2. Средна вътрешна температура
      - name: "Indoor Temperature Avg"
        unique_id: indoor_temperature_avg
        unit_of_measurement: "°C"
        device_class: temperature
        state_class: measurement
        state: >-
          {% set rooms = ['sensor.downstairs_temperature','sensor.home_living_room_temperature','sensor.bedroom_damian_temperature','sensor.bedroom_honey_temperature','sensor.alex_room_temperature'] %}
          {% set temps = rooms|map('states')|map('float',none)|reject('none')|list %}
          {{ (temps|average)|round(2) if temps else 21.0 }}

      # 3. Forecast Min 72h – 100 % работещ (за Met.no)
      - name: "Forecast Min 72h"
        unique_id: forecast_min_72h
        unit_of_measurement: "°C"
        device_class: temperature
        state_class: measurement
        icon: mdi:thermometer-low
        state: >
          {% set data = state_attr('weather.forecast_home_osoica','forecast') %}
          {% if data is none or data == [] %}
            {{ (states('sensor.cu401b_s_outside_temperature')|float(5) - 2)|round(1) }}
          {% else %}
            {% set min_temp = 99 %}
            {% for entry in data[0:7] %}
              {% set low = entry.templow if (entry.templow is defined and entry.templow is not none) else (entry.temperature|default(99)) %}
              {% if low|float < min_temp %} {% set min_temp = low|float %} {% endif %}
            {% endfor %}
            {% set margin = 0.4 if min_temp >= 0 else 0.7 if min_temp >= -5 else 1.0 if min_temp >= -10 else 1.3 if min_temp >= -15 else 1.6 if min_temp >= -20 else 2.0 %}
            {{ (min_temp - margin)|round(1) }}
          {% endif %}

      # 4. Solar Forecast Score 72h - (за Met.no)
      - name: "Solar Forecast Score 72h"
        unique_id: solar_forecast_score_72h
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:weather-sunny
        state: >
          {% set data = state_attr('weather.forecast_home_osoica','forecast') %}
          {% if data is none or data == [] %}
            35
          {% else %}
            {% set score = 0 %}
            {% for entry in data[0:3] %}
              {% set c = (entry.condition | default('cloudy') | string | lower) %}
              {% if c in ['clearsky','fair','sunny'] %} {% set score = score + 100 %}
              {% elif c == 'partlycloudy' %} {% set score = score + 60 %}
              {% elif c == 'cloudy' %} {% set score = score + 20 %}
              {% endif %}
            {% endfor %}
            {{ (score / 3) | round(0) }}
          {% endif %}

      # 5. Компресорна защита
      - name: "Compressor Runtime Protection"
        unique_id: compressor_runtime_protection
        state: >-
          {% if is_state('binary_sensor.cu401b_s_compressor','on') %}
            {% set m = state_attr('binary_sensor.cu401b_s_compressor','runtime_minutes')|default(0)|int(default=0) %}
            {% if m > 45 %} very_long
            {% elif m > 35 %} long
            {% elif m > 25 %} medium
            {% else %} normal {% endif %}
          {% else %} off {% endif %}
        icon: >-
          {{ 'mdi:alert' if states('sensor.compressor_runtime_protection') in ['very_long','long'] else 'mdi:engine' }}

      # 6. Режим Comfort/Eco
      - name: "Heating Current Mode 2030"
        unique_id: heating_current_mode_2030
        state: >-
          {% set home = is_state('device_tracker.damian_iphone_14','Home-Osoica') %}
          {% set force = is_state('input_boolean.heating_preheat_48h_force',' parms on') %}
          {% set wknd = is_state('input_boolean.heating_weekend_mode_auto','on') and now().weekday() in [5,6] %}
          {% set holiday = is_state('calendar.blgarski_ofitsialni_praznitsi_2025_2030','on') %}
          {{ 'Comfort' if home or force or wknd or holiday else 'Eco' }}
        icon: >-
          {{ 'mdi:home-heart' if states('sensor.heating_current_mode_2030') == 'Comfort' else 'mdi:leaf' }}
          
      - name: "PV Boost Smoothed"
        unique_id: pv_boost_smoothed
        unit_of_measurement: "°C"
        state: "0.0"
        icon: mdi:solar-power

      # PI интеграли (инициализация)
      - name: "Heating PI Integral"
        unique_id: heating_pi_integral
        unit_of_measurement: "°C·h"
        icon: mdi:chart-line
        state: "0.0"
      - name: "PI Integral Living"
        unique_id: pi_integral_living
        unit_of_measurement: "°C·h"
        icon: mdi:home-thermometer
        state: "0.0"
      - name: "PI Integral Damian"
        unique_id: pi_integral_damian
        unit_of_measurement: "°C·h"
        state: "0.0"
      - name: "PI Integral Honey"
        unique_id: pi_integral_honey
        unit_of_measurement: "°C·h"
        state: "0.0"
      - name: "PI Integral Downstairs"
        unique_id: pi_integral_downstairs
        unit_of_measurement: "°C·h"
        state: "0.0"
      - name: "PI Integral Alex"
        unique_id: pi_integral_alex
        unit_of_measurement: "°C·h"
        state: "0.0"

# ───── ЗАДЪЛЖИТЕЛЕН TIME_DATE СЕНЗОР ─────
sensor:
  - platform: time_date
    display_options:
      - 'time'
      - 'date'
      - 'date_time'
      - 'date_time_iso'
