template:
  # ───── 0. Критичен сензор за дата/час ─────
  - sensor:
      - name: Datetime
        unique_id: datetime
        state: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
        icon: mdi:clock-outline

  # ───── 1. Бързи сензори (на всеки 30 секунди) ─────
  - trigger:
      - platform: time_pattern
        seconds: /30
    sensor:
      - name: Outdoor Temperature
        unique_id: outdoor_temperature
        unit_of_measurement: °C
        device_class: temperature
        state_class: measurement
        state: >
          {% set v = states('sensor.cu401b_s_outside_temperature') | float(999) %}
          {% if v|abs < 80 %}
            {{ v|round(1) }}
          {% else %}
            {{ states('sensor.netatmo_outdoor_temperature') | float(5) | round(1) }}
          {% endif %}

      - name: Indoor Temperature Avg
        unique_id: indoor_temperature_avg
        unit_of_measurement: °C
        device_class: temperature
        state_class: measurement
        state: >
          {% set rooms = [
            'sensor.downstairs_temperature',
            'sensor.home_living_room_temperature',
            'sensor.bedroom_damian_temperature',
            'sensor.bedroom_honey_temperature',
            'sensor.alex_room_temperature'
          ] %}
          {% set temps = rooms | map('states') | map('float', none) | reject('none') | list %}
          {{ (temps | average) | round(2) if temps else 21.0 }}

      - name: Forecast Min 72h
        unique_id: forecast_min_72h
        unit_of_measurement: °C
        device_class: temperature
        state_class: measurement
        state: >
          {% set f = state_attr('weather.forecast_home_osoica', 'forecast') or [] %}
          {% if f|length == 0 %}
            {{ (states('sensor.cu401b_s_outside_temperature')|float(5) - 2)|round(1) }}
          {% else %}
            {% set lows = f[0:7] | map(attribute='templow') | map('float', 99) | list %}
            {% set min_temp = lows | min %}
            {% set margins = [0.4, 0.7, 1.0, 1.3, 1.6, 2.0] %}
            {% set thresholds = [0, -5, -10, -15, -20] %}
            {% set idx = thresholds | reject('ge', min_temp) | list | length %}
            {% set margin = margins[idx-1] if idx > 0 else margins[-1] %}
            {{ (min_temp - margin) | round(1) }}
          {% endif %}

      - name: Forecast Min 96h
        unique_id: forecast_min_96h
        unit_of_measurement: °C
        state: >
          {% set f = state_attr('weather.forecast_home_osoica', 'forecast') or [] %}
          {% if f|length < 4 %}
            {{ states('sensor.forecast_min_72h') | float(5) | round(1) }}
          {% else %}
            {{ (f[3:10] | map(attribute='templow') | map('float', 99) | list | min) | round(1) }}
          {% endif %}

      - name: Solar Forecast Score 72h
        unique_id: solar_forecast_score_72h
        unit_of_measurement: "%"
        state_class: measurement
        state: >
          {% set f = state_attr('weather.forecast_home_osoica', 'forecast') or [] %}
          {% if f|length == 0 %}
            35
          {% else %}
            {% set score = 0 %}
            {% for day in f[0:3] %}
              {% set c = (day.condition | default('cloudy') | lower) %}
              {% if c in ['sunny','fair','clearsky','clear'] %}{% set score = score + 100 %}
              {% elif c == 'partlycloudy' %}{% set score = score + 60 %}
              {% elif c in ['cloudy','overcast'] %}{% set score = score + 20 %}{% endif %}
            {% endfor %}
            {{ (score / 3) | round(0) | int }}
          {% endif %}

  # ───── 2. Компресорна защита ─────
  - trigger:
      - platform: state
        entity_id: binary_sensor.cu401b_s_compressor
    sensor:
      - name: Compressor Runtime Protection
        unique_id: compressor_runtime_protection
        state: >
          {% if is_state('binary_sensor.cu401b_s_compressor','on') %}
            {% set m = state_attr('binary_sensor.cu401b_s_compressor','runtime_minutes')|int(0) %}
            {% if m > 45 %}very_long{% elif m > 35 %}long{% elif m > 25 %}medium{% else %}normal{% endif %}
          {% else %}off{% endif %}
        icon: >
          {% set s = states('sensor.compressor_runtime_protection') %}
          {% if s == 'very_long' %}mdi:alert-decagram
          {% elif s == 'long' %}mdi:alert
          {% elif s == 'medium' %}mdi:alert-outline
          {% elif s == 'normal' %}mdi:engine
          {% else %}mdi:engine-off{% endif %}

  # ───── 3. Режим и дневна защита ─────
  - trigger:
      - platform: time_pattern
        minutes: /5
    sensor:
      - name: Heating Current Mode 2030
        unique_id: heating_current_mode_2030
        state: >
          {% set home = is_state('binary_sensor.damian_really_home','on') %}
          {% set force = is_state('input_boolean.heating_preheat_48h_force','on') %}
          {% set weekend = is_state('input_boolean.heating_weekend_mode_auto','on') and now().weekday() >= 5 %}
          {% set holiday = is_state('calendar.blgarski_ofitsialni_praznitsi_2025_2030','on') %}
          {{ 'Comfort' if home or force or weekend or holiday else 'Eco' }}
        icon: >
          {{ 'mdi:home-heart' if states('sensor.heating_current_mode_2030') == 'Comfort' else 'mdi:leaf' }}

  # ───── 4. Първоначални сензори (инициализация) ─────
  - sensor:
      - name: PV Boost Smoothed
        unique_id: pv_boost_smoothed
        unit_of_measurement: °C
        state: "0.0"
        icon: mdi:solar-power-variant

      - name: Heating PI Integral
        unique_id: heating_pi_integral
        unit_of_measurement: °C·h
        state: "0.0"

      - name: PI Integral Living
        unique_id: pi_integral_living
        unit_of_measurement: °C·h
        state: "0.0"

      - name: PI Integral Downstairs
        unique_id: pi_integral_downstairs
        unit_of_measurement: °C·h
        state: "0.0"

      - name: PI Integral Damian
        unique_id: pi_integral_damian
        unit_of_measurement: °C·h
        state: "0.0"

      - name: PI Integral Honey
        unique_id: pi_integral_honey
        unit_of_measurement: °C·h
        state: "0.0"

      - name: PI Integral Alex
        unique_id: pi_integral_alex
        unit_of_measurement: °C·h
        state: "0.0"

      - name: Long Comfort Counter
        unique_id: long_comfort_counter
        state: "0.0"
        unit_of_measurement: h

  # ───── 5. Damian Really Home ─────
  - binary_sensor:
      - name: Damian Really Home
        unique_id: damian_really_home
        state: >
          {% set dist = state_attr('device_tracker.damian_iphone_14', 'distance') | default(999999) | float(999999) %}
          {% set in_zone = is_state('device_tracker.damian_iphone_14', 'Home-Osoica') %}
          {% set wifi = is_state('binary_sensor.damian_iphone_wifi', 'on') %}
          {{ 'on' if (in_zone or dist < 2500 or (wifi and dist < 8000)) else 'off' }}
        icon: mdi:home-account
